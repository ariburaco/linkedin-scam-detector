model Job {
  id             String                      @id @default(cuid())
  linkedinJobId  String?                     @unique @db.VarChar(100)
  jobUrlHash     String                      @db.VarChar(64)
  url            String                      @db.Text
  title          String                      @db.VarChar(500)
  company        String                      @db.VarChar(500)
  description    String                      @db.Text
  location       String?                     @db.VarChar(500)
  salary         String?                     @db.VarChar(200)
  employmentType String?                     @db.VarChar(100)
  postedAt       DateTime?
  scrapedAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  scrapedBy      String? // User ID who scraped this job (nullable for anonymous scrapes)
  rawData        Json? // Store any additional scraped data not in structured fields
  embedding      Unsupported("vector(768)")? // Vector embedding for semantic search (Gemini embedding-004)
  metadata       Json? // Store LLM cost and usage metadata (tokens, costs, model info, etc.)

  // Relations
  analyses    JobAnalysis[]
  extractions JobExtraction[]

  @@index([jobUrlHash])
  @@index([company])
  @@index([linkedinJobId])
  @@index([scrapedBy])
  @@map("scam_detector_job")
}

model JobAnalysis {
  id               String   @id @default(cuid())
  jobId            String
  job              Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  riskScore        Int
  riskLevel        String   @db.VarChar(20) // safe, caution, danger
  flags            Json // Array of flag objects
  summary          String?  @db.Text
  analysisSource   String   @db.VarChar(50) // gemini, cache, fallback, local
  localRulesResult Json? // Store preliminary local rules result if available
  metadata         Json? // Store LLM cost and usage metadata (tokens, costs, model info, etc.)
  analyzedAt       DateTime @default(now())

  @@index([jobId])
  @@index([analyzedAt])
  @@index([riskLevel])
  @@map("scam_detector_job_analysis")
}

model JobExtraction {
  id    String @id @default(cuid())
  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Extracted structured data
  requirements     Json? // Array of requirements (skills, experience, education, etc.)
  responsibilities Json? // Array of job responsibilities
  benefits         Json? // Array of benefits/perks
  qualifications   Json? // Array of qualifications

  // Structured salary data
  salaryMin      Float?
  salaryMax      Float?
  salaryCurrency String? @db.VarChar(10) // USD, EUR, etc.
  salaryPeriod   String? @db.VarChar(20) // hourly, monthly, yearly

  // Experience and education
  experienceLevel String? @db.VarChar(50) // entry, mid, senior, executive
  educationLevel  String? @db.VarChar(100) // high-school, bachelor, master, phd

  // Work details
  workType     String?  @db.VarChar(50) // remote, hybrid, on-site
  workSchedule String?  @db.VarChar(50) // full-time, part-time, contract, etc.
  isAgency     Boolean? // true if posting is from recruitment agency/staffing firm

  // Extracted skills (structured)
  skills Json? // Array of {name, category, required, experience}

  // Job metrics and indicators
  urgencyScore         Int? // Urgency score 0-100 (high = explicit deadlines, immediate hiring)
  qualityScore         Int? // Quality score 0-10 (information completeness, professional writing)
  competitivenessScore Int? // Competitiveness score 0-10 (estimated competition level)
  scamIndicators       Json? // Array of scam indicator strings (complements existing scam detection)
  startDate            DateTime? // Job start date if mentioned
  applicationDeadline  DateTime? // Application deadline if mentioned

  // Full extraction result (for flexibility)
  extractedData Json? // Complete extraction result with all parsed information

  // Structured embedding for precise skill matching
  structuredEmbedding Unsupported("vector(768)")? @map("structured_embedding") // Vector embedding from structured data

  // Metadata
  extractedAt      DateTime @default(now())
  extractionModel  String?  @db.VarChar(100) // Model used for extraction (e.g., gemini-2.0-flash-exp)
  extractionSource String   @default("gemini") @db.VarChar(50) // gemini, manual, etc.
  metadata         Json? // Store LLM cost and usage metadata (tokens, costs, model info, etc.)

  @@index([jobId])
  @@index([extractedAt])
  @@index([experienceLevel])
  @@index([workType])
  @@index([urgencyScore])
  @@map("scam_detector_job_extraction")
}

model DiscoveredJob {
  id             String  @id @default(cuid())
  linkedinJobId  String  @unique @db.VarChar(100) // LinkedIn job ID (unique constraint)
  url            String  @db.Text // Full LinkedIn job URL
  title          String  @db.VarChar(500)
  company        String  @db.VarChar(500)
  location       String? @db.VarChar(500)
  employmentType String? @db.VarChar(100) // Full-time, Part-time, Contract, etc.
  workType       String? @db.VarChar(50) // Remote, Hybrid, On-site
  isPromoted     Boolean @default(false) // Whether job is promoted
  isEasyApply    Boolean @default(false) // Whether Easy Apply is available
  hasVerified    Boolean @default(false) // Whether company/job is verified
  insight        String? @db.VarChar(200) // e.g., "Actively reviewing applicants"
  postedDate     String? @db.VarChar(100) // e.g., "1 week ago", "3 days ago"
  companyLogoUrl String? @db.Text // Company logo image URL

  // Discovery metadata
  discoveredAt    DateTime @default(now())
  discoveredBy    String? // User ID who discovered (nullable for anonymous)
  discoverySource String   @db.VarChar(50) // "search", "recommended", "collections", etc.
  discoveryUrl    String?  @db.Text // URL of the page where job was discovered

  // Processing tracking
  processedAt        DateTime? // When full job details were scraped (null = not processed)
  processedJobId     String?   @db.VarChar(100) // Reference to Job.id after processing
  processingStatus   String    @default("pending") @db.VarChar(50) // "pending", "queued", "processing", "completed", "failed"
  processingAttempts Int       @default(0) // Retry counter
  lastProcessError   String?   @db.Text // Error message if failed

  // Priority scoring (calculated)
  priorityScore Float? // Higher = process first

  // Raw data for flexibility
  rawData Json? // Store any additional scraped data

  // Note: No foreign key relation to Job table
  // DiscoveredJobs are created BEFORE full job scraping
  // processedJobId can be used for manual lookup after processing

  @@index([linkedinJobId])
  @@index([discoveredAt])
  @@index([processedAt])
  @@index([discoverySource])
  @@index([processingStatus])
  @@index([priorityScore])
  @@map("scam_detector_discovered_job")
}
